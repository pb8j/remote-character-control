<!DOCTYPE html>
<html>
<head>
    <title>Mobile Robot View</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50; /* Dark blue heading */
            padding: 15px;
            margin: 0;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 1.5em;
        }

        #robot-viewer {
            flex-grow: 1; /* Take up available space */
            background-color: #e3f2fd; /* Lighter blue for 3D viewer */
            position: relative; /* For absolute positioning of overlay text */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            display: block;
            width: 100% !important; /* Ensure canvas fills container */
            height: 100% !important; /* Ensure canvas fills container */
            object-fit: contain;
        }

        #camera-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }

        #joint-angles-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            max-height: 30%; /* Limit height if many joints */
            overflow-y: auto;
            pointer-events: none; /* Allows interaction with canvas below */
            z-index: 10;
        }
        #joint-angles-display div {
            margin-bottom: 4px;
        }

        #message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            min-width: 250px;
        }
        #message-box button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        #message-box button:hover {
            background-color: #0056b3;
        }

        /* Basic spinner for loading */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #007bff;
            animation: spin 1s ease infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Mobile Robot View</h1>

    <div id="robot-viewer">
        <div id="camera-status">Camera: <span id="camera-state">Not Active</span></div>
        <div id="joint-angles-display">
            <strong>Joint Angles:</strong>
            <div id="joint-shoulder_yaw">Shoulder Yaw: 0.00</div>
            <div id="joint-shoulder_pitch">Shoulder Pitch: 0.00</div>
            <div id="joint-elbow_pitch">Elbow Pitch: 0.00</div>
            <div id="joint-wrist_pitch">Wrist Pitch: 0.00</div>
            <div id="joint-wrist_roll">Wrist Roll: 0.00</div>
            <div id="joint-finger_joint">Finger Grasp: 0.00</div>
            <div id="joint-finger_joint_2">Finger Grasp 2: 0.00</div>
        </div>
        <div class="spinner" id="loading-spinner"></div>
    </div>

    <div id="message-box">
        <p id="message-text"></p>
        <button onclick="hideMessageBox()">OK</button>
    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls for mobile interaction -->
    <!-- The OrbitControls script needs to be loaded AFTER three.min.js -->
    <!-- Using a CDN path known to attach OrbitControls to the global THREE object -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- three-urdf-loader for loading URDF models -->
    <script src="https://unpkg.com/three-urdf-loader@0.0.12/dist/URDFLoader.js"></script>
    <!-- Socket.IO Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>
        // --- Configuration ---
        // IMPORTANT: Replace with your actual deployed backend URL (e.g., from Render)
        const FLASK_APP_URL = 'https://remote-character-control.onrender.com';
        const VIDEO_WIDTH = 320; // Width for camera frames
        const VIDEO_HEIGHT = 240; // Height for camera frames
        const FPS = 10; // Frames per second for camera streaming

        // --- Global Variables ---
        let socket;
        let videoStream;
        let videoInterval;
        let cameraActive = false; // State to track if camera is actively sending frames
        let cameraStateElement = document.getElementById('camera-state');

        // Three.js variables
        let scene, camera, renderer, controls;
        let robotModel; // This will hold your loaded URDF model
        const jointDisplays = {}; // To update joint angle text dynamically

        // --- Custom Message Box Functions (replaces alert/confirm) ---
        function showMessageBox(message) {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-box').style.display = 'block';
        }

        function hideMessageBox() {
            document.getElementById('message-box').style.display = 'none';
        }

        // --- Three.js Initialization and Robot Loading ---
        function initThreeJS() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe3f2fd); // Light blue background

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / (window.innerHeight - 50), 0.1, 1000); // Adjust aspect ratio for header
            camera.position.set(2, 2, 2);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight - 50); // Adjust size for header
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('robot-viewer').appendChild(renderer.domElement);

            // OrbitControls - The fix: Access OrbitControls from the global THREE object
            // The OrbitControls.js script typically adds OrbitControls to THREE.
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2; // Prevent camera from going below ground

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 2); // Increased intensity
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            // Ground Plane
            const planeGeometry = new THREE.PlaneGeometry(10, 10);
            const planeMaterial = new THREE.MeshStandardMaterial({ color: 0xcccccc, side: THREE.DoubleSide });
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = Math.PI / 2;
            plane.position.y = -0.5;
            scene.add(plane);

            // URDF Loader
            const loader = new URDFLoader(); // Assuming URDFLoader is globally available after script inclusion
            loader.load('./robots/robot_arg85_description.URDF', result => {
                robotModel = result;
                scene.add(robotModel);
                console.log('Robot model loaded:', robotModel);

                // Initialize joint display elements
                for (const jointName in robotModel.joints) {
                    const displayDiv = document.getElementById(`joint-${jointName}`);
                    if (displayDiv) {
                        jointDisplays[jointName] = displayDiv;
                    }
                }
                document.getElementById('loading-spinner').style.display = 'none'; // Hide spinner
            },
            // Progress callback
            xhr => {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            // Error callback
            err => {
                console.error('Error loading URDF:', err);
                showMessageBox('Failed to load robot model. Check URDF path and mesh files and server.');
                document.getElementById('loading-spinner').style.display = 'none';
            });

            // Animation loop
            const animate = () => {
                requestAnimationFrame(animate);
                controls.update(); // Only required if controls.enableDamping or controls.autoRotate are set to true
                renderer.render(scene, camera);
            };
            animate();

            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / (window.innerHeight - 50);
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight - 50);
            });
        }

        // --- WebSocket Communication ---
        function setupWebSocket() {
            socket = io(FLASK_APP_URL);

            socket.on('connect', () => {
                console.log('Mobile View: Connected to Flask SocketIO. Socket ID:', socket.id);
                socket.emit('mobile_client_ready');
            });

            socket.on('disconnect', (reason) => {
                console.log('Mobile View: Disconnected from Flask SocketIO. Reason:', reason);
                stopCameraStream();
                cameraStateElement.textContent = 'Disconnected';
            });

            socket.on('connect_error', (err) => {
                console.error('Mobile View: Socket.IO Connection Error:', err.message, err.description);
                showMessageBox('Failed to connect to backend. Please ensure the server is running.');
                cameraStateElement.textContent = 'Connection Error';
            });

            // Listen for commands from control panel to start/stop camera
            socket.on('start_camera', () => {
                console.log('Mobile View: Received start_camera command.');
                startCameraStream();
            });

            socket.on('stop_camera', () => {
                console.log('Mobile View: Received stop_camera command.');
                stopCameraStream();
            });

            // Listen for joint angle updates from the control panel
            socket.on('joint_angle_updated', (data) => {
                const { joint_name, angle } = data;
                console.log(`Mobile View: Received joint update for ${joint_name}: ${angle} radians`);
                if (robotModel && robotModel.joints[joint_name]) {
                    // Update the 3D model's joint
                    robotModel.joints[joint_name].setJointValue(angle);

                    // Update the on-screen display
                    if (jointDisplays[joint_name]) {
                        jointDisplays[joint_name].textContent = `${joint_name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}: ${angle.toFixed(2)}`;
                    }
                }
            });

            // Receive initial joint states on connect
            socket.on('initial_joint_states', (jointStates) => {
                console.log('Mobile View: Received initial joint states:', jointStates);
                if (robotModel) {
                    for (const jointName in jointStates) {
                        if (robotModel.joints[jointName]) {
                            robotModel.joints[jointName].setJointValue(jointStates[jointName]);
                            if (jointDisplays[jointName]) {
                                jointDisplays[jointName].textContent = `${jointName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}: ${jointStates[jointName].toFixed(2)}`;
                            }
                        }
                    }
                }
            });
        }

        // --- Camera Streaming Functions ---
        async function startCameraStream() {
            if (cameraActive) {
                console.log("Camera stream already active.");
                return;
            }

            try {
                // Request camera access
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const videoElement = document.createElement('video'); // Create a hidden video element
                videoElement.srcObject = videoStream;
                videoElement.play();

                // Create a canvas to draw video frames
                const canvas = document.createElement('canvas');
                canvas.width = VIDEO_WIDTH;
                canvas.height = VIDEO_HEIGHT;
                const context = canvas.getContext('2d');

                // Start sending frames
                videoInterval = setInterval(() => {
                    if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7); // Adjust quality as needed
                        const base64Data = dataUrl.split(',')[1]; // Get base64 part
                        socket.emit('mobile_camera_frame', { frame: base64Data });
                        // console.log("Sent camera frame."); // Log only if debugging frame rate
                    }
                }, 1000 / FPS); // Send frames at defined FPS

                cameraActive = true;
                cameraStateElement.textContent = 'Active';
                showMessageBox('Camera streaming started successfully!');
                console.log('Mobile View: Camera streaming started.');

            } catch (err) {
                console.error('Mobile View: Error accessing camera:', err);
                showMessageBox(`Failed to start camera: ${err.message || 'Permission denied'}`);
                cameraStateElement.textContent = 'Error';
                cameraActive = false;
            }
        }

        function stopCameraStream() {
            if (!cameraActive) {
                console.log("No camera stream to stop.");
                return;
            }
            clearInterval(videoInterval);
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop()); // Stop all tracks
            }
            cameraActive = false;
            cameraStateElement.textContent = 'Not Active';
            showMessageBox('Camera streaming stopped.');
            console.log('Mobile View: Camera streaming stopped.');
        }

        // --- Initialize on Window Load ---
        window.onload = function() {
            initThreeJS();
            setupWebSocket();
        };

    </script>
</body>
</html>
